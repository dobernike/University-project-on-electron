# WEB API

# WebRTC

## Что такое WebRTC

[https://www.youtube.com/watch?v=lslU9JM36Qo]

WebRTC (Web Real Time Communications) — это стандарт, который описывает передачу потоковых аудиоданных, видеоданных и контента от браузера и к браузеру в режиме реального времени без установки плагинов или иных расширений.

WebRTC работает только на современных браузерах (ie11 не может)

получение доступа к камере и микрофона в веб приложениях напрямую без посредников (например flash)

Может в Peer-To-Peer

WebRTC может быть аналогом Skype

## Зачем и как блокировать WebRTC

[https://www.youtube.com/watch?v=o0_0DwDMZSA]

Все соеденения защищены и зашифрованны (hangouts на нем)

Недостаток:
Раскрытие ip-адресса

Можно заблокировать WebRTC

или скрыть ip с помощью плагина
(whoer plugin)

## WebRTC: делаем видеозвонки из браузера / Григорий Петров (Voximplant)

[https://www.youtube.com/watch?v=PcvYEQxwEQ8]

Плохая передача звука и картинки через Flash

### Зачем нужно WebRTC?

Для замены Flash и Air как средства коммуникации в реальном времени между браузерами и/или приложениями

P2P сетевые подключения c NAT traversal
Голос и видео: получить, отправить, играть
Битрейт, кодеки, разрешения, шум, эхо
P2P-передача данных в стиле UDP или TCP
Запись голоса и видео в браузере

`2010 придумали и Осень 2013 первые реализации`

`2017 все сделали`

### 4 браузера с WebRTC: оно одинаковое?

Только H.264 видеокодек в Safari
Screen sharing, canvas только Chrome и Firefox
В Edge нет "data channel"
H.264UC, TURN, Trickle ICE и другие мелочи

### разница в SDP

WebRTC очень нравятся P2P-подключение
STUN сервера, чтобы узнать внешний IP
TURN сервера, если P2P не удалось
Обмен информацией через SDP-пакеты
Еще в SDP информация о медиаданных
SDP плохо, если более одного медиапотока

### Более одного медиапотока в SDP

Chrome, Safari и Edge: "Plan B" SDP
Firefox: "Unified plan SDP"
Либы вроде "adapter.js" для "перевода"

### Теперь без SDP

WebRTC 1.1 это "oRTC" без SDP
Edge - единственный браузер с этой версией
...и версией WebRTC 1.0 "для совместимости"

### Насколько юзабельно?

Работает для простых голосовых/видео звонков

- Нет включений/выключений голоса/видео
- Нет screen sharing во время видеозвонка
- Не используются фичи вроде "simulcast"

### Не только в браузерах

"libwebrtc" от Google собирается под любую платформу

Такую как Android, iOS или PC

альтернатива - "openwebrtc"

### заблуждения о WebRTC

WebRTC не "безопаснее"
C WebRTC не всегда ниже задержки
Это не "чистое P2P": нужна сигнализация

### WebRTC - это круто!

Skype for Web
Онлайн-образование
Телемедицина
Сенсоры реального времени (не в Edge)
Стриминг интерактивного видео
... и много других

## О WebRTC просто и без магии: как устроен путь кадра в Интернете / Кирилл Роговой (Skyeng)

[https://www.youtube.com/watch?v=EZQ_RA5KTc8]

### WebRTC в одном слайде

TCP - WebSocket
UDP - WebRTC

- - Media
- - P2P

Открываем UDP порт
Знаем IP:port партнера
Заворачиваем трафик в RTP

### 7 шагов от веб-камеры до экрана

1. Захват камеры

- navigator.mediaDevices.
- Размер чистого потока
  - изображение 640х480, 32bit: 1.2mb
  - 30 кадров, 1 секунда: 36mb
  - битрейт: 288mbps

2. Кодирование

- JPEG, 640x480
  - 1.2mb -> 123kb
  - 288mbps -> 28mbps
- VP9, 1280x720 - 1.5mbps
- Диффы, keyframe, interframe

3. Запаковка в RTP

- Порядок
- Время
- Треки
- Оверхед: ~5% (62 / 1204)
- RTCP: RTP Control Protocol

4. Передача по сети через UDP

- Главный плюс UDP: минимальный интервал между пакетами
- Минусы UDP
  - пакеты теряются
  - пакеты приходят поздно
  - пакеты приходят в другом порядке

5. Распаковка RTP

- Восстанавливаем порядок
- Достаем видео-трафик
- Передаем в декодер

6. Декодирование

- Передаем данные в правильном порядке
- На выходе -- чистый видео-поток -- MediaStream

7. Отрисовка на экране <video>

- Прикрепляем поток к элементу и получаем картинку

### Реальный мир

- Кодек: keyframe, interframe
- Сеть
  - пакеты теряются - packet loss
  - пакеты приходят поздно - delay
  - пакеты приходят в другом порядке - jitter
- RTP
  - Хранит порядок и время
  - RTCP

### Откуда потери пакетов?

- Остаются в стенах дома - Random loss или Lossy network
- Дропаются по ошибке: баги в OC или сетевом оборудовании
- Дропаются из-за перегрузки сети - Network congestion

### Пакет не пришел вовремя! Что делать?

- Нельзя проигнорировать: keyframe, interframe
- RTCP: попросим прислать пакет заново, но нужно ждать RTT
- Что если потеряли сразу несколько пакетов?

#### 4 решения

1. рендерим на оди RTT позже - Jitter buffer

- Минус: дополнительная постоянная задержка
- Плюсы:
  - Есть время запросить недостающий пакет
  - При массовой потере, больше времени на запрос keyframe

2. уменьшаем битрейт

- Битрейт = FPS _ качество _ разрешение
- Минусы:
  - Хуже качество (временно)
  - Не поможет с random loss
- Плюс: поможет с network congestion

3. Forward Error Correction

- Умное дублирование данных на уровне кодека
- Минус: выше битрейт - усуглубляет network congestion
- Плюс: выше шанс доставки контента с первого раза

4. сетевой тюнинг

- Лучшие сетевые маршруты
- Настройка серверов и маршрутизаторов
